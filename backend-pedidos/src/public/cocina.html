<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Panel de Cocina</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f4f6f9;
      }
      h1 {
        color: #2c3e50;
        margin-bottom: 10px;
      }
      #estado {
        font-weight: bold;
        margin-bottom: 20px;
      }
      #estado.conectado {
        color: green;
      }
      #estado.desconectado {
        color: red;
      }
      #pedidos {
        max-height: 80vh;
        overflow-y: auto;
      }
      .pedido {
        border: 1px solid #ccc;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 0.4s forwards;
      }
      .mesa {
        font-weight: bold;
        color: #e67e22;
        margin-bottom: 5px;
      }
      ul {
        margin: 5px 0 0 20px;
        padding: 0;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“¦ Panel de Cocina - Pedidos Pagados</h1>
    <div id="estado" class="desconectado">ðŸ”´ Desconectado de Socket.IO</div>
    <div id="pedidos"></div>

    <script>
      const backendURL = "http://localhost:4000";
      const restaurantId = "1"; // Por ahora trabajamos con restaurantId 1

      // âš¡ Token de servicio de cocina para restaurantId 1
      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyZXN0YXVyYW50SWQiOjEsInJvbCI6ImtpdGNoZW4iLCJpYXQiOjE3NTUyODI5MTgsImV4cCI6MTc4NjgxODkxOH0.0ZMZBKuHJRXkloSlSqvMsG9Fkkk4wnDyjRpUImDf9sQ";

      // ConexiÃ³n a Socket.IO usando token
      const socket = io(backendURL, {
        query: { restaurantId },
        auth: { token },
      });

      const estado = document.getElementById("estado");
      const pedidosContainer = document.getElementById("pedidos");

      socket.on("connect", () => {
        estado.textContent = "ðŸŸ¢ Conectado a Socket.IO";
        estado.className = "conectado";
      });
      socket.on("disconnect", () => {
        estado.textContent = "ðŸ”´ Desconectado de Socket.IO";
        estado.className = "desconectado";
      });

      const renderPedido = (pedido) => {
        if (
          String(pedido.restaurant_id || pedido.restaurantId) !== restaurantId
        )
          return;

        const div = document.createElement("div");
        div.className = "pedido";

        const productosHTML = (pedido.items || [])
          .map(
            (item) =>
              `<li>${item.cantidad}x ${item.nombre || item.producto} - S/ ${
                item.precio_unitario
              }</li>`
          )
          .join("");

        div.innerHTML = `
          <div class="mesa">Mesa: ${pedido.mesa || "N/A"}</div>
          <div>Pedido #${pedido.id} - Estado: ${pedido.estado}</div>
          <ul>${productosHTML}</ul>
          <strong>Total: S/ ${pedido.monto}</strong>
        `;

        pedidosContainer.appendChild(div);
        pedidosContainer.scrollTop = pedidosContainer.scrollHeight;

        socket.emit("kitchen.ack", {
          orderId: pedido.id,
          restaurantId,
          type: "received",
        });
      };

      socket.on("nuevo_pedido", renderPedido);
      socket.on("pedido_pagado", renderPedido);

      // Cargar pedidos pagados desde API usando token
      fetch(`${backendURL}/api/pedidos/cocina?estado=pagado`, {
        headers: { Authorization: `Bearer ${token}` },
      })
        .then((res) => res.json())
        .then((data) => {
          if (Array.isArray(data)) data.forEach((p) => renderPedido(p));
          else console.warn("La respuesta de pedidos no es un array:", data);
        })
        .catch((err) =>
          console.error("Error cargando pedidos existentes:", err)
        );
    </script>
  </body>
</html>
